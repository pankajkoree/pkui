name: Publish to npm

on:
  # Trigger the workflow when a new tag is pushed (e.g., git push --tags)
  push:
    tags:
      - 'v*' # Run when a tag like v1.0.5 is pushed

jobs:
  publish:
    # Use the specific environment name you set in npm (if any)
    # environment: npm-publish 
    
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC connection with npm
      contents: read  # Required to check out the code

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' 

      - name: Install dependencies
        run: npm install

      - name: Run TypeScript Build
        # This assumes you have a 'build' script in your package.json 
        # that runs 'tsc' and compiles your code into the 'dist' folder.
        run: npm run build 
        
      - name: Publish package to npm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/
        
      - run: npm publish --access public
        env:
          # This relies on the OIDC connection; no TOKEN secret needed!
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }} 
          # Note: The presence of this line is standard, but the actual 
          # token is securely handled via OIDC for Trusted Publishers.